<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <style>
        .config-section {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }
        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }
        .form-group input,
        .form-group select {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        .section-header {
            border-bottom: 2px solid #eee;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .section-title {
            margin: 0;
            color: #333;
            font-size: 1.25rem;
        }
        .section-description {
            margin: 0.5rem 0 0 0;
            color: #666;
            font-size: 0.875rem;
        }
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: flex-end;
        }
        .help-text {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.25rem;
        }
        .current-config {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .config-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .config-item:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">EMQX Go Dashboard</div>
                <nav class="nav">
                    <a href="/dashboard">Dashboard</a>
                    <a href="/connections">Connections</a>
                    <a href="/sessions">Sessions</a>
                    <a href="/subscriptions">Subscriptions</a>
                    <a href="/certificates">Certificates</a>
                    <a href="/tls-config" class="active">TLS Config</a>
                    <a href="/monitoring">Monitoring</a>
                </nav>
                <div class="user-menu">
                    <span>Welcome, admin</span>
                    <a href="/logout" class="btn btn-small">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h1 class="page-title">TLS Configuration</h1>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button id="refresh-btn" class="btn btn-primary btn-small" onclick="refreshPage()">Refresh</button>
                </div>
            </div>

            <!-- TLS Server Configuration -->
            <div class="config-section">
                <div class="section-header">
                    <h2 class="section-title">TLS Server Configuration</h2>
                    <p class="section-description">Configure TLS settings for secure MQTT connections</p>
                </div>

                <form id="tls-config-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="tls-enabled">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="tls-enabled" name="enabled" checked>
                                    <span>Enable TLS</span>
                                </div>
                            </label>
                            <div class="help-text">Enable TLS encryption for MQTT connections</div>
                        </div>

                        <div class="form-group">
                            <label for="tls-port">TLS Port</label>
                            <input type="number" id="tls-port" name="port" value="8883" min="1" max="65535">
                            <div class="help-text">Port number for TLS connections (default: 8883)</div>
                        </div>

                        <div class="form-group">
                            <label for="verify-mode">Client Certificate Verification</label>
                            <select id="verify-mode" name="verify">
                                {{range .VerifyModes}}
                                <option value="{{.value}}">{{.label}}</option>
                                {{end}}
                            </select>
                            <div class="help-text">How to handle client certificate verification</div>
                        </div>

                        <div class="form-group">
                            <label for="client-cert-auth">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="client-cert-auth" name="client_cert_auth">
                                    <span>Require Client Certificate Authentication</span>
                                </div>
                            </label>
                            <div class="help-text">Require clients to provide valid certificates</div>
                        </div>

                        <div class="form-group">
                            <label for="server-cert">Server Certificate</label>
                            <select id="server-cert" name="certificate_id">
                                <option value="">Select a certificate...</option>
                                <!-- Will be populated by JavaScript -->
                            </select>
                            <div class="help-text">Certificate to use for TLS server</div>
                        </div>

                        <div class="form-group">
                            <label for="ca-cert">CA Certificate</label>
                            <select id="ca-cert" name="ca_certificate_id">
                                <option value="">Select a CA certificate...</option>
                                <!-- Will be populated by JavaScript -->
                            </select>
                            <div class="help-text">CA certificate for client certificate verification</div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Save Configuration</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
                    </div>
                </form>
            </div>

            <!-- X.509 Authentication Configuration -->
            <div class="config-section">
                <div class="section-header">
                    <h2 class="section-title">X.509 Authentication Configuration</h2>
                    <p class="section-description">Configure how client certificates are used for authentication</p>
                </div>

                <form id="x509-config-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="x509-enabled">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="x509-enabled" name="enabled">
                                    <span>Enable X.509 Authentication</span>
                                </div>
                            </label>
                            <div class="help-text">Use client certificates for user authentication</div>
                        </div>

                        <div class="form-group">
                            <label for="identity-source">Identity Source</label>
                            <select id="identity-source" name="identity_source">
                                {{range .IdentitySources}}
                                <option value="{{.value}}">{{.label}}</option>
                                {{end}}
                            </select>
                            <div class="help-text">How to extract user identity from certificate</div>
                        </div>

                        <div class="form-group">
                            <label for="identity-pattern">Identity Pattern (Regex)</label>
                            <input type="text" id="identity-pattern" name="identity_pattern" placeholder="^.*$">
                            <div class="help-text">Regular expression to validate extracted identity</div>
                        </div>

                        <div class="form-group">
                            <label for="ca-chain-depth">CA Chain Depth</label>
                            <input type="number" id="ca-chain-depth" name="ca_chain_depth" value="10" min="1" max="20">
                            <div class="help-text">Maximum depth for certificate chain verification</div>
                        </div>

                        <div class="form-group">
                            <label for="verify-cert-chain">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="verify-cert-chain" name="verify_cert_chain" checked>
                                    <span>Verify Certificate Chain</span>
                                </div>
                            </label>
                            <div class="help-text">Validate the entire certificate chain</div>
                        </div>

                        <div class="form-group">
                            <label for="allowed-cns">Allowed Common Names</label>
                            <input type="text" id="allowed-cns" name="allowed_cns" placeholder="client1,client2,client3">
                            <div class="help-text">Comma-separated list of allowed certificate CNs (optional)</div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Save X.509 Configuration</button>
                        <button type="button" class="btn btn-secondary" onclick="resetX509Form()">Reset</button>
                    </div>
                </form>
            </div>

            <!-- Current Configuration Display -->
            <div class="config-section">
                <div class="section-header">
                    <h2 class="section-title">Current Configuration</h2>
                    <p class="section-description">Currently active TLS and X.509 settings</p>
                </div>

                <div id="current-config">
                    <div class="current-config">
                        <h4>TLS Configuration</h4>
                        <div id="tls-current-config">
                            <div class="config-item">
                                <span><strong>Status:</strong></span>
                                <span id="current-tls-status">Loading...</span>
                            </div>
                            <div class="config-item">
                                <span><strong>Port:</strong></span>
                                <span id="current-tls-port">Loading...</span>
                            </div>
                            <div class="config-item">
                                <span><strong>Verify Mode:</strong></span>
                                <span id="current-verify-mode">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <div class="current-config">
                        <h4>X.509 Authentication</h4>
                        <div id="x509-current-config">
                            <div class="config-item">
                                <span><strong>Status:</strong></span>
                                <span id="current-x509-status">Loading...</span>
                            </div>
                            <div class="config-item">
                                <span><strong>Identity Source:</strong></span>
                                <span id="current-identity-source">Loading...</span>
                            </div>
                            <div class="config-item">
                                <span><strong>Chain Depth:</strong></span>
                                <span id="current-chain-depth">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        function refreshPage() {
            location.reload();
        }

        function resetForm() {
            document.getElementById('tls-config-form').reset();
            loadCertificates();
        }

        function resetX509Form() {
            document.getElementById('x509-config-form').reset();
        }

        function loadCertificates() {
            fetch('/api/certificates')
                .then(response => response.json())
                .then(data => {
                    const serverCertSelect = document.getElementById('server-cert');
                    const caCertSelect = document.getElementById('ca-cert');

                    // Clear existing options (except the first one)
                    serverCertSelect.innerHTML = '<option value="">Select a certificate...</option>';
                    caCertSelect.innerHTML = '<option value="">Select a CA certificate...</option>';

                    if (data.certificates) {
                        data.certificates.forEach(cert => {
                            if (cert.type === 'server') {
                                const option = document.createElement('option');
                                option.value = cert.id;
                                option.textContent = `${cert.name} (${cert.id})`;
                                serverCertSelect.appendChild(option);
                            } else if (cert.type === 'ca') {
                                const option = document.createElement('option');
                                option.value = cert.id;
                                option.textContent = `${cert.name} (${cert.id})`;
                                caCertSelect.appendChild(option);
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading certificates:', error);
                });
        }

        function loadCurrentConfig() {
            // Load X.509 configuration
            fetch('/api/x509-auth')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('current-x509-status').textContent = data.enabled ? 'Enabled' : 'Disabled';
                    document.getElementById('current-identity-source').textContent = data.identity_source || 'Not configured';
                    document.getElementById('current-chain-depth').textContent = data.ca_chain_depth || 'Not configured';
                })
                .catch(error => {
                    console.error('Error loading X.509 config:', error);
                    document.getElementById('current-x509-status').textContent = 'Error loading';
                });
        }

        document.getElementById('tls-config-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const tlsConfig = {
                enabled: formData.has('enabled'),
                port: parseInt(formData.get('port')),
                verify: formData.get('verify'),
                client_cert_auth: formData.has('client_cert_auth'),
                certificate_id: formData.get('certificate_id'),
                ca_certificate_id: formData.get('ca_certificate_id')
            };

            fetch('/api/tls-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(tlsConfig)
            })
            .then(response => {
                if (response.ok) {
                    alert('TLS configuration saved successfully!');
                    loadCurrentConfig();
                } else {
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
            })
            .catch(error => {
                alert('Error saving TLS configuration: ' + error.message);
            });
        });

        document.getElementById('x509-config-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const allowedCNs = formData.get('allowed_cns');

            const x509Config = {
                enabled: formData.has('enabled'),
                identity_source: formData.get('identity_source'),
                identity_pattern: formData.get('identity_pattern'),
                ca_chain_depth: parseInt(formData.get('ca_chain_depth')),
                verify_cert_chain: formData.has('verify_cert_chain'),
                allowed_cns: allowedCNs ? allowedCNs.split(',').map(cn => cn.trim()) : []
            };

            fetch('/api/x509-auth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(x509Config)
            })
            .then(response => {
                if (response.ok) {
                    alert('X.509 authentication configuration saved successfully!');
                    loadCurrentConfig();
                } else {
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
            })
            .catch(error => {
                alert('Error saving X.509 configuration: ' + error.message);
            });
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadCertificates();
            loadCurrentConfig();
        });
    </script>
</body>
</html>