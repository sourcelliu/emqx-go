# emqx-go 并发测试计划和修复方案

## 1. 并发问题分析总结

### 已发现的数据竞争问题：
1. **Session测试中的Buffer竞争**：在 `pkg/session/session_test.go` 中，同一个 `bytes.Buffer` 被两个goroutine同时访问
   - 写者：session.Start() 写入MQTT数据包
   - 读者：testutil.ReadPacket() 读取数据包进行验证
   - 位置：`session_test.go:39-68`

### 潜在风险区域：
1. **Topic Store**：虽然使用了RWMutex，但订阅/取消订阅的批量操作可能存在竞争
2. **Actor Mailbox**：无缓冲或满缓冲情况下的阻塞发送
3. **Broker连接处理**：并发客户端连接时的session注册/注销
4. **消息路由**：高并发发布时的subscriber查找和消息分发

## 2. 并发测试计划

### 2.1 数据竞争修复
- [ ] 修复session测试中的Buffer竞争
- [ ] 添加线程安全的测试工具
- [ ] 验证所有存储组件的线程安全性

### 2.2 压力测试场景
- [ ] 大量并发客户端连接测试
- [ ] 高频消息发布/订阅测试
- [ ] 并发主题订阅/取消订阅测试
- [ ] 内存和CPU压力下的稳定性测试

### 2.3 性能基准测试
- [ ] 消息吞吐量基准测试
- [ ] 并发连接数基准测试
- [ ] 内存使用效率测试
- [ ] 延迟测量和优化

### 2.4 错误恢复测试
- [ ] Actor崩溃恢复测试
- [ ] 网络中断恢复测试
- [ ] 内存不足情况下的降级策略

## 3. 修复优先级

### 高优先级（立即修复）
1. Session测试中的数据竞争
2. Topic store的批量操作原子性
3. Mailbox的非阻塞发送机制

### 中优先级（后续版本）
1. 消息路由的性能优化
2. 内存池化管理
3. 连接池管理

### 低优先级（长期规划）
1. 分布式一致性保证
2. 持久化存储优化
3. 监控和度量完善

## 4. 测试工具和方法

### 4.1 测试工具
- Go race detector (`go test -race`)
- 内存泄漏检测 (`go test -memprofile`)
- CPU性能分析 (`go test -cpuprofile`)
- 并发基准测试 (`go test -bench . -cpu=1,2,4,8`)

### 4.2 测试环境
- 单机高并发测试
- 多核心CPU测试
- 内存受限环境测试
- 网络延迟模拟测试

## 5. 成功指标

### 5.1 功能性指标
- 所有race detector测试通过
- 99.99%的消息传递成功率
- 零数据丢失保证

### 5.2 性能指标
- 支持10,000+并发连接
- 消息延迟 < 10ms (P99)
- 内存使用 < 1GB (10K连接)
- CPU使用率 < 80% (正常负载)

### 5.3 稳定性指标
- 7×24小时稳定运行
- 优雅降级和错误恢复
- 内存泄漏零容忍

## 6. 实现路线图

### Phase 1: 修复现有问题 (1-2天)
- 修复已知数据竞争
- 完善现有测试用例
- 基础并发安全验证

### Phase 2: 压力测试 (2-3天)
- 实现高并发测试场景
- 性能瓶颈识别和优化
- 错误处理完善

### Phase 3: 基准测试和优化 (2-3天)
- 建立性能基准
- 持续集成中的并发测试
- 文档和最佳实践

### Phase 4: 长期监控 (持续)
- 生产环境监控
- 性能回归检测
- 社区反馈处理